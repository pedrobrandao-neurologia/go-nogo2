<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tarefa Go–NoGo (v1.3)</title>
<meta name="description" content="Tarefa Go–NoGo responsiva, com temporização precisa e exportação CSV." />
<style>
  :root{
    --bg:#f4f6f8; --fg:#2c3e50; --accent:#2563eb; --ok:#16a34a; --warn:#f97316; --err:#dc2626;
    --card:#ffffff; --muted:#64748b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
    color:var(--fg); background:var(--bg); display:flex; align-items:center; justify-content:center; padding:12px;
  }
  #app{
    width:100%; max-width:720px; background:var(--card); border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.08);
    padding:20px 20px 24px;
  }
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  h1{font-size:1.15rem; margin:0; font-weight:700}
  .version{font-size:.8rem; color:var(--muted)}
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  label{font-size:.95rem}
  input[type="text"]{
    padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; min-width:220px; font-size:1rem;
  }
  button{
    appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
    background:var(--accent); color:#fff; transition:transform .05s ease, opacity .2s ease, background .2s ease;
  }
  button:hover{opacity:.95}
  button:active{transform:translateY(1px)}
  button.secondary{background:#0f172a}
  button.ghost{background:#e2e8f0; color:#0f172a}
  button.success{background:var(--ok)}
  button.warn{background:var(--warn)}
  button.error{background:var(--err)}
  .sep{height:1px; background:#eef2f7; margin:16px 0}
  #panel{
    display:grid; place-items:center; gap:10px; margin:10px 0 6px;
  }
  #fix{
    width:44px; height:44px; border-radius:50%; background:#0ea5e9; display:none;
  }
  #estimulo{
    width:min(32vh,320px); height:min(32vh,320px); max-width:78vw; max-height:78vw;
    border-radius:50%; background:transparent; box-shadow:inset 0 0 0 4px #94a3b8;
    transition:background-color .08s ease, box-shadow .2s ease;
    touch-action:manipulation; user-select:none; -webkit-user-select:none; cursor:pointer;
  }
  #msg{min-height:28px; text-align:center; font-size:1.1rem; font-weight:600}
  #status{font-size:.92rem; color:var(--muted); text-align:center}
  #legend{font-size:.92rem; color:var(--muted); margin-top:2px; text-align:center}
  #results h2{margin:.2rem 0 .5rem; font-size:1.05rem}
  .grid{
    display:grid; grid-template-columns:1fr 1fr; gap:10px;
  }
  .card{
    border:1px solid #e5e7eb; border-radius:12px; padding:12px
  }
  .kv{display:flex; justify-content:space-between; font-size:.98rem; padding:4px 0}
  .k{color:var(--muted)}
  .v{font-weight:700}
  #fsBtn{position:fixed; top:12px; right:12px; z-index:10}
  @media (max-width:520px){
    .grid{grid-template-columns:1fr}
  }
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:.9rem}
  .hide{display:none !important}
  .note{font-size:.9rem; color:#0f172a; background:#eff6ff; border:1px solid #bfdbfe; padding:10px; border-radius:10px}
</style>
</head>
<body>
<button id="fsBtn" class="ghost" type="button" title="Tela cheia">Tela cheia</button>

<div id="app" role="main" aria-live="polite">
  <header>
    <h1>Tarefa Go–NoGo <span class="version">v1.3</span></h1>
    <div class="row">
      <button id="aboutBtn" class="ghost" type="button">Ajuda</button>
    </div>
  </header>

  <div class="row" style="gap:10px 12px; align-items:flex-end">
    <div class="col">
      <label for="pid">Identificador do participante</label><br/>
      <input id="pid" type="text" inputmode="latin" autocomplete="off" placeholder="ex.: BR-001-A" />
    </div>
    <div class="col">
      <label for="mode">Modo</label><br/>
      <div class="row">
        <button id="reducedBtn" type="button">Teste reduzido</button>
        <button id="fullBtn" type="button" class="secondary">Teste completo</button>
      </div>
    </div>
    <div class="col">
      <label>Controles</label><br/>
      <div class="row">
        <button id="startBtn" type="button" class="success">Iniciar</button>
        <button id="abortBtn" type="button" class="warn" disabled>Abortar</button>
        <button id="resetBtn" type="button" class="ghost">Reset</button>
      </div>
    </div>
  </div>

  <div class="sep"></div>

  <div id="panel" aria-label="Área do estímulo">
    <div id="msg" class="muted">Informe o ID do participante, escolha o modo e clique em <b>Iniciar</b>.</div>
    <div id="fix"></div>
    <div id="estimulo" aria-label="Círculo do estímulo" title="Clique ou pressione ESPAÇO quando o círculo for colorido (Go). Não responda se estiver preto (NoGo)."></div>
    <div id="status" class="muted mono"></div>
    <div id="legend" class="muted">Resposta: clique/ESPAÇO em <b>Go</b> (colorido). <b>Não responda</b> em <b>NoGo</b> (preto).</div>
  </div>

  <div class="sep"></div>

  <section id="results" class="hide">
    <h2>Resultados</h2>
    <div class="grid">
      <div class="card">
        <div class="kv"><div class="k">Go Accuracy</div><div class="v" id="goAcc">–</div></div>
        <div class="kv"><div class="k">Erros de omissão</div><div class="v" id="omiss">–</div></div>
        <div class="kv"><div class="k">Erros de comissão</div><div class="v" id="comm">–</div></div>
        <div class="kv"><div class="k">RT médio (ms)</div><div class="v" id="rtMean">–</div></div>
        <div class="kv"><div class="k">RT SD (ms)</div><div class="v" id="rtSd">–</div></div>
      </div>
      <div class="card">
        <div class="kv"><div class="k">d′</div><div class="v" id="dprime">–</div></div>
        <div class="kv"><div class="k">β</div><div class="v" id="beta">–</div></div>
        <div class="kv"><div class="k">Trials (Go/NoGo)</div><div class="v" id="counts">–</div></div>
        <div class="kv"><div class="k">Seed</div><div class="v mono" id="seedLbl">–</div></div>
        <div class="kv"><div class="k">Versão</div><div class="v" id="verLbl">v1.3</div></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="dlDetailBtn" type="button">Baixar CSV detalhado</button>
      <button id="dlSummaryBtn" type="button" class="secondary">Baixar CSV resumido</button>
      <button id="postBtn" type="button" class="ghost">Enviar para endpoint (opcional)</button>
    </div>
    <p class="note">Dica: publique no GitHub Pages. Se desejar coleta automática, configure um endpoint (por ex., Google Apps Script) e preencha a constante <span class="mono">POST_ENDPOINT</span> no código.</p>
  </section>
</div>

<!-- Dialog Ajuda -->
<dialog id="aboutDlg">
  <h3>Instruções</h3>
  <p>Pressione <b>ESPAÇO</b> ou clique no círculo quando ele estiver <b>colorido</b> (condição Go). Em <b>preto</b> (NoGo), <b>não responda</b>.</p>
  <p>O teste usa temporização de alta precisão (<span class="mono">performance.now()</span>), jitter de intervalos e calcula <i>d′</i> e β com correção log-linear.</p>
  <div class="row" style="justify-content:flex-end">
    <form method="dialog"><button type="submit" class="ghost">Fechar</button></form>
  </div>
</dialog>

<script>
/* ========= Configuração (ajuste conforme o estudo) ========= */
const VERSION = "v1.3";
const POST_ENDPOINT = ""; // opcional: URL para POST (JSON). Deixe vazio para desativado.
const CONFIG = {
  reduced: { go: 24, nogo: 12 },
  full:    { go: 48, nogo: 24 },
  goColors: ["#ef4444","#22c55e","#3b82f6"], // vermelho, verde, azul
  nogoColor: "#000000",                       // preto
  stimDurationMs: 900,                        // tempo em tela do estímulo
  responseWindowMs: 900,                      // janela útil para resposta (coincide com duração)
  isiMs: [600, 900],                          // jitter (intervalo entre tentativa e próxima)
  preFixMs: [250, 400],                       // jitter antes do estímulo (fixação)
  blockBreakEvery: 9999,                      // sem pausa (ajuste, ex.: 24 para pausas em blocos)
};

/* ========= Estado ========= */
const State = {
  running: false,
  trials: [],
  idx: 0,
  startStamp: 0,           // performance.now() na onset do estímulo
  tookResponse: false,     // previne múltiplas respostas por trial
  pid: "",
  mode: "full",
  seed: 0,
  prng: null,
  audio: null,
  session: {},
};

/* ========= Utilidades ========= */
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function mulberry32(a){ // PRNG determinístico e leve
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t>>>15), t | 1);
    t ^= t + Math.imul(t ^ (t>>>7), t | 61);
    return ((t ^ (t>>>14)) >>> 0) / 4294967296;
  }
}
function seededShuffle(arr, rnd){ // Fisher–Yates
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function jitter([a,b], rnd){ return a + Math.floor(rnd()*(b-a+1)); }

/* ========= Estatística: d′ e β com ajuste log-linear ========= */
function erfcinv(p){
  // aproximação numérica (como a sua base, com refinamento curto)
  let j=0, x, err, t, pp;
  if (p >= 2) return -100;
  if (p <= 0) return  100;
  pp = (p < 1) ? p : 2 - p;
  t = Math.sqrt(-2 * Math.log(pp / 2));
  x = -0.70711 * ((2.30753 + t*0.27061) / (1 + t*(0.99229 + t*0.04481)) - t);
  for (; j < 2; j++){
    err = erfc(x) - pp;
    x += err / (1.12837916709551257*Math.exp(-x*x) - x*err);
  }
  return (p < 1) ? x : -x;
}
function erfc(x){ return 1 - erf(x); }
function erf(x){
  const t = 1 / (1 + 0.5*Math.abs(x));
  const tau = t * Math.exp(
    -x*x + ((((((((0.17087277*t - 0.82215223)*t + 1.48851587)*t - 1.13520398)*t + 0.27886807)*t - 0.18628806)*t + 0.09678418)*t + 0.37409196)*t + 1.00002368)*t - 1.26551223
  );
  return x >= 0 ? 1 - tau : tau - 1;
}
function zFromP(p){ // quantil padrão; usa erfcinv
  p = clamp01(p);
  if (p === 0)  p = Number.EPSILON;
  if (p === 1)  p = 1-Number.EPSILON;
  return -Math.sqrt(2)*erfcinv(2*p);
}
function sdMetrics(hits, Ngo, fas, Nnogo){
  // correção log-linear (Hautus, 1995): +0.5 / (N+1)
  const hRate = (hits + 0.5)/(Ngo + 1);
  const faRate= (fas  + 0.5)/(Nnogo + 1);
  const zH = zFromP(hRate);
  const zF = zFromP(faRate);
  const d = zH - zF;
  const beta = Math.exp((zF*zF - zH*zH)/2);
  return { d, beta, hRate, faRate };
}

/* ========= DOM ========= */
const $ = sel => document.querySelector(sel);
const pidEl = $('#pid');
const startBtn = $('#startBtn');
const abortBtn = $('#abortBtn');
const resetBtn = $('#resetBtn');
const reducedBtn = $('#reducedBtn');
const fullBtn = $('#fullBtn');
const fsBtn = $('#fsBtn');
const aboutBtn = $('#aboutBtn');
const aboutDlg = $('#aboutDlg');

const msgEl = $('#msg');
const fixEl = $('#fix');
const stimEl = $('#estimulo');
const statusEl = $('#status');
const resultsSec = $('#results');

const goAccEl = $('#goAcc');
const omissEl = $('#omiss');
const commEl = $('#comm');
const rtMeanEl = $('#rtMean');
const rtSdEl = $('#rtSd');
const dprimeEl = $('#dprime');
const betaEl = $('#beta');
const countsEl = $('#counts');
const seedLbl = $('#seedLbl');

const dlDetailBtn = $('#dlDetailBtn');
const dlSummaryBtn = $('#dlSummaryBtn');
const postBtn = $('#postBtn');

/* ========= Áudio ========= */
function initAudio(){
  if (State.audio) return;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) return;
  State.audio = new AudioCtx();
}
function beep(freq=880, dur=0.10){
  if (!State.audio) return;
  const t0 = State.audio.currentTime;
  const osc = State.audio.createOscillator();
  const g = State.audio.createGain();
  osc.type='sine'; osc.frequency.value = freq;
  osc.connect(g); g.connect(State.audio.destination);
  g.gain.value = 0.0001;
  g.gain.exponentialRampToValueAtTime(0.2, t0+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
  osc.start(t0);
  osc.stop(t0+dur);
}

/* ========= Fullscreen ========= */
async function toggleFullscreen(){
  try{
    if (!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
      fsBtn.textContent = "Sair tela cheia";
    } else {
      await document.exitFullscreen();
      fsBtn.textContent = "Tela cheia";
    }
  }catch(e){}
}
document.addEventListener('fullscreenchange',()=>{
  fsBtn.textContent = document.fullscreenElement ? "Sair tela cheia":"Tela cheia";
});
fsBtn.addEventListener('click', toggleFullscreen);

/* ========= Construção de trials ========= */
function buildTrials(mode, prng){
  const cfg = CONFIG[mode];
  const trials = [];
  // Go: balance de cores
  for (let i=0;i<cfg.go;i++){
    const col = CONFIG.goColors[i % CONFIG.goColors.length];
    trials.push({cond:"go", stim:col});
  }
  // NoGo
  for (let j=0;j<cfg.nogo;j++){
    trials.push({cond:"nogo", stim:CONFIG.nogoColor});
  }
  // embaralha
  seededShuffle(trials, prng);
  // anexa placeholders
  return trials.map((t,k)=>({
    ...t,
    trial:k+1, rt:null, resp:null, acc:null,
    onset:null, // ms (performance.now)
    preFix: jitter(CONFIG.preFixMs, prng),
    isi: jitter(CONFIG.isiMs, prng)
  }));
}

/* ========= Preparar sessão ========= */
function prepareSession(){
  // valida ID
  const pid = (pidEl.value||"").trim();
  if (!pid){
    alert("Por favor, informe o identificador do participante.");
    pidEl.focus();
    return false;
  }
  State.pid = pid;
  // seed estável a partir do ID
  let seed = 0x811C9DC5; // FNV-1a base
  for (let i=0;i<pid.length;i++){
    seed ^= pid.charCodeAt(i);
    seed = Math.imul(seed, 16777619) >>> 0;
  }
  State.seed = seed >>> 0;
  State.prng = mulberry32(State.seed);
  // metadados
  State.session = {
    version: VERSION,
    pid: State.pid,
    seed: State.seed,
    userAgent: navigator.userAgent,
    lang: navigator.language,
    screen: {w: window.screen?.width, h: window.screen?.height, dpr: window.devicePixelRatio||1},
    tsISO: new Date().toISOString(),
    mode: State.mode
  };
  return true;
}

/* ========= Execução ========= */
async function run(){
  if (State.running) return;
  if (!prepareSession()) return;

  // inicia áudio por gesto
  initAudio();
  if (State.audio && State.audio.state === "suspended"){
    try{ await State.audio.resume(); }catch(e){}
  }

  // UI
  startBtn.disabled = true;
  abortBtn.disabled = false;
  reducedBtn.disabled = true;
  fullBtn.disabled = true;
  pidEl.disabled = true;
  resultsSec.classList.add('hide');
  msgEl.textContent = "Prepare-se…";
  statusEl.textContent = "Apresentando instruções e fixação";

  // trials
  State.trials = buildTrials(State.mode, State.prng);
  State.idx = 0;

  // pequeno atraso e segue
  await waitMs(500);
  nextTrial();
}

function waitMs(ms){
  return new Promise(res=>setTimeout(res, ms));
}

async function nextTrial(){
  if (!State.running && State.idx===0){ State.running = true; }
  if (!State.running) return;

  if (State.idx >= State.trials.length){
    return finish();
  }

  const t = State.trials[State.idx];

  // 1) Fixação/jitter pré-estímulo
  fixEl.style.display = "block";
  stimEl.style.background = "transparent";
  msgEl.textContent = "Fixe o olhar…";
  statusEl.textContent = `Ensaio ${t.trial}/${State.trials.length}  •  Pré-fixação ${t.preFix} ms`;
  State.tookResponse = false;
  await waitMs(t.preFix);

  // 2) Onset estímulo
  fixEl.style.display = "none";
  stimEl.style.boxShadow = "inset 0 0 0 0px transparent";
  stimEl.style.background = t.stim;
  msgEl.textContent = t.cond === "go" ? "GO: responda!" : "NoGo: não responda.";
  State.startStamp = performance.now();
  t.onset = State.startStamp;

  // 3) Janela de resposta + duração do estímulo
  await waitMs(CONFIG.responseWindowMs);

  // 4) Encerrar janela, computar omissão/NoGo correto, e ISI
  stimEl.style.background = "transparent";
  stimEl.style.boxShadow = "inset 0 0 0 4px #94a3b8";

  if (!t.resp){
    // sem resposta
    if (t.cond === "go"){
      t.resp = "miss"; t.rt = null; t.acc = 0; // omissão
    } else {
      t.resp = "withhold"; t.rt = null; t.acc = 1; // inibição correta
    }
  }

  statusEl.textContent = `Ensaio ${t.trial}/${State.trials.length}  •  ISI ${t.isi} ms`;
  await waitMs(t.isi);

  State.idx++;
  // pausa de bloco opcional
  if (CONFIG.blockBreakEvery>0 && State.idx>0 && State.idx % CONFIG.blockBreakEvery === 0 && State.idx < State.trials.length){
    msgEl.textContent = "Pausa breve. Pressione Iniciar para continuar.";
    startBtn.disabled = false;
    abortBtn.disabled = false;
    State.running = false;
    return;
  }
  nextTrial();
}

/* ========= Resposta do participante ========= */
function registerResponse(){
  if (!State.running) return;
  const t = State.trials[State.idx];
  if (!t) return;
  if (State.tookResponse) return; // já respondeu neste ensaio

  const now = performance.now();
  const rt = now - State.startStamp;

  // só aceita dentro da janela do estímulo
  if (rt < 0 || rt > CONFIG.responseWindowMs) return;

  State.tookResponse = true;
  t.rt = Math.round(rt);
  t.resp = "go";
  t.acc = (t.cond === "go") ? 1 : 0;

  // feedback sonoro opcional
  if (t.acc === 1){ beep(1000, .08); } else { beep(220, .10); }
}

stimEl.addEventListener('pointerdown', registerResponse);
document.addEventListener('keydown', (e)=>{
  if (e.code === 'Space'){ e.preventDefault(); registerResponse(); }
});

/* ========= Finalização ========= */
function finish(){
  State.running = false;
  startBtn.disabled = false;
  abortBtn.disabled = true;
  reducedBtn.disabled = false;
  fullBtn.disabled = false;
  pidEl.disabled = false;

  computeAndRender();
  msgEl.textContent = "Teste concluído. Obrigado!";
  statusEl.textContent = "Você pode baixar os arquivos CSV abaixo.";
  resultsSec.classList.remove('hide');
}

/* ========= Abort/Reset ========= */
function abortRun(){
  if (!State.running) return;
  State.running = false;
  msgEl.textContent = "Teste abortado.";
  statusEl.textContent = "";
  abortBtn.disabled = true;
  startBtn.disabled = false;
  reducedBtn.disabled = false;
  fullBtn.disabled = false;
  pidEl.disabled = false;
}
function hardReset(){
  State.running = false;
  State.trials = [];
  State.idx = 0;
  State.pid = "";
  pidEl.value = "";
  msgEl.textContent = "Informe o ID do participante, escolha o modo e clique em Iniciar.";
  statusEl.textContent = "";
  resultsSec.classList.add('hide');
  stimEl.style.background = "transparent";
  stimEl.style.boxShadow = "inset 0 0 0 4px #94a3b8";
  abortBtn.disabled = true;
  startBtn.disabled = false;
  reducedBtn.disabled = false;
  fullBtn.disabled = false;
  pidEl.disabled = false;
}

/* ========= Cálculos e UI de resultados ========= */
function computeAndRender(){
  let goN=0, goHits=0, goMiss=0, rtSum=0, rt2Sum=0, rtN=0;
  let nogoN=0, commErr=0;

  for (const t of State.trials){
    if (t.cond === "go"){
      goN++;
      if (t.acc === 1){
        goHits++;
        if (t.rt!=null){ rtSum += t.rt; rt2Sum += t.rt*t.rt; rtN++; }
      } else {
        goMiss++;
      }
    } else {
      nogoN++;
      if (t.acc === 0) commErr++;
    }
  }

  const goAcc = goN ? (100*goHits/goN) : 0;
  const omiss = goN ? (100*goMiss/goN) : 0;
  const comm  = nogoN ? (100*commErr/nogoN) : 0;
  const rtMean = rtN ? (rtSum/rtN) : NaN;
  const rtVar  = rtN ? (rt2Sum/rtN) - (rtMean*rtMean) : NaN;
  const rtSd   = rtN ? Math.sqrt(Math.max(0, rtVar)) : NaN;

  const { d, beta, hRate, faRate } = sdMetrics(goHits, goN, commErr, nogoN);

  goAccEl.textContent = isFinite(goAcc)? goAcc.toFixed(2)+"%":"–";
  omissEl.textContent = isFinite(omiss)? omiss.toFixed(2)+"%":"–";
  commEl.textContent  = isFinite(comm)?  comm.toFixed(2)+"%":"–";
  rtMeanEl.textContent= isFinite(rtMean)? rtMean.toFixed(2):"–";
  rtSdEl.textContent  = isFinite(rtSd)?   rtSd.toFixed(2):"–";
  dprimeEl.textContent= isFinite(d)? d.toFixed(2):"–";
  betaEl.textContent  = isFinite(beta)? beta.toFixed(2):"–";
  countsEl.textContent= `${goN}/${nogoN}`;
  seedLbl.textContent = String(State.seed);

  // retorna objeto (pode ser útil)
  return {
    goAcc, omiss, comm, rtMean, rtSd, dPrime:d, beta, goN, nogoN, goHits, goMiss, commErr, hRate, faRate
  };
}

/* ========= CSV ========= */
function toCsvRow(fields){
  return fields.map(v=>{
    if (v==null) return "";
    const s = String(v);
    if (/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
    return s;
  }).join(",") + "\n";
}
function downloadCsv(filename, content){
  const blob = new Blob([content], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}

function csvDetailed(){
  if (!State.trials.length){ alert("Nenhum dado disponível."); return; }
  const meta = State.session;
  const headerMeta = "# session,"+JSON.stringify(meta)+"\n";
  let csv = headerMeta;
  csv += toCsvRow(["pid","trial","cond","stim","resp","acc","rt_ms","onset_ms","preFix_ms","isi_ms","seed","version"]);
  for (const t of State.trials){
    csv += toCsvRow([
      State.pid, t.trial, t.cond, t.stim, t.resp, t.acc,
      t.rt, Math.round(t.onset ?? 0), t.preFix, t.isi,
      State.seed, VERSION
    ]);
  }
  return csv;
}

function csvSummary(){
  const r = computeAndRender();
  const meta = State.session;
  const headerMeta = "# session,"+JSON.stringify(meta)+"\n";
  let csv = headerMeta;
  csv += toCsvRow(["pid","mode","goN","nogoN","goHits","goMiss","commErr","goAcc_%","omiss_%","comm_%","rtMean_ms","rtSd_ms","dprime","beta","hRate","faRate","seed","version"]);
  csv += toCsvRow([
    State.pid, State.mode, r.goN, r.nogoN, r.goHits, r.goMiss, r.commErr,
    r.goAcc.toFixed(2), r.omiss.toFixed(2), r.comm.toFixed(2),
    isFinite(r.rtMean)? r.rtMean.toFixed(2) : "",
    isFinite(r.rtSd)?   r.rtSd.toFixed(2)   : "",
    isFinite(r.dPrime)? r.dPrime.toFixed(4) : "",
    isFinite(r.beta)?   r.beta.toFixed(4)   : "",
    r.hRate.toFixed(4), r.faRate.toFixed(4), State.seed, VERSION
  ]);
  return csv;
}

/* ========= POST opcional ========= */
async function postJson(endpoint, payload){
  const res = await fetch(endpoint, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  return res.ok;
}

/* ========= Eventos UI ========= */
reducedBtn.addEventListener('click', ()=>{
  State.mode = "reduced";
  reducedBtn.classList.add('secondary');
  fullBtn.classList.remove('secondary');
});
fullBtn.addEventListener('click', ()=>{
  State.mode = "full";
  fullBtn.classList.add('secondary');
  reducedBtn.classList.remove('secondary');
});
startBtn.addEventListener('click', run);
abortBtn.addEventListener('click', abortRun);
resetBtn.addEventListener('click', hardReset);
aboutBtn.addEventListener('click', ()=>aboutDlg.showModal());
aboutDlg.addEventListener('close', ()=>{});

dlDetailBtn.addEventListener('click', ()=>{
  if (!State.pid){ alert("Informe o ID do participante."); return; }
  const csv = csvDetailed();
  downloadCsv(`gng_detailed_${State.pid}.csv`, csv);
});
dlSummaryBtn.addEventListener('click', ()=>{
  if (!State.pid){ alert("Informe o ID do participante."); return; }
  const csv = csvSummary();
  downloadCsv(`gng_summary_${State.pid}.csv`, csv);
});
postBtn.addEventListener('click', async ()=>{
  if (!POST_ENDPOINT){ alert("POST_ENDPOINT não configurado."); return; }
  const payload = {
    session: State.session,
    trials: State.trials
  };
  try{
    const ok = await postJson(POST_ENDPOINT, payload);
    alert(ok ? "Dados enviados com sucesso." : "Falha no envio.");
  }catch(e){
    alert("Erro ao enviar: "+e.message);
  }
});

/* ========= Inicialização ========= */
(function init(){
  // mensagem inicial
  statusEl.textContent = "";
  // prevenção de rolagem com espaço em alguns navegadores
  window.onkeydown = (e)=>{ if (e.code==="Space") e.preventDefault(); };
})();
</script>
</body>
</html>
